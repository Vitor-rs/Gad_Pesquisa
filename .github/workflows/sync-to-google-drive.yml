name: Sync Repository to Google Drive

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  sync-to-drive:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Dependencies
      run: |
        pip install google-api-python-client google-auth google-auth-oauthlib google-auth-httplib2
        
    - name: Pre-check Environment Variables
      run: |
        python << EOF
        import os
        import sys
        
        print("ğŸ” Verificando variÃ¡veis de ambiente...")
        print("=" * 60)
        
        # VariÃ¡veis necessÃ¡rias
        required_vars = {
            'GOOGLE_CREDENTIALS': '${{ secrets.GOOGLE_CREDENTIALS }}',
            'GOOGLE_DRIVE_FOLDER_ID': '${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}'
        }
        
        # VariÃ¡veis opcionais do repositÃ³rio
        repo_vars = {
            'REPOSITORY_NAME': '${{ github.event.repository.name }}',
            'BRANCH': '${{ github.ref_name }}',
            'COMMIT_SHA': '${{ github.sha }}',
            'ACTOR': '${{ github.actor }}'
        }
        
        missing_vars = []
        
        # Verificar variÃ¡veis essenciais
        for name, value in required_vars.items():
            if value and value.strip():
                if 'CREDENTIALS' in name:
                    print(f"âœ… {name}: {'*' * 8}")
                else:
                    print(f"âœ… {name}: {value}")
            else:
                print(f"âŒ {name}: NÃƒO ENCONTRADA")
                missing_vars.append(name)
        
        # Mostrar variÃ¡veis do repositÃ³rio
        print("\nğŸ“‹ InformaÃ§Ãµes do repositÃ³rio:")
        for name, value in repo_vars.items():
            print(f"â„¹ï¸  {name}: {value}")
        
        # Verificar se temos o mÃ­nimo necessÃ¡rio
        if missing_vars:
            print(f"\nâŒ ERRO: VariÃ¡veis essenciais nÃ£o encontradas: {', '.join(missing_vars)}")
            print("\nVerifique se vocÃª configurou os secrets no GitHub:")
            print("- VÃ¡ em Settings â†’ Secrets and variables â†’ Actions")
            print("- Configure GOOGLE_CREDENTIALS e GOOGLE_DRIVE_FOLDER_ID")
            sys.exit(1)
        
        print("\nâœ… Todas as variÃ¡veis necessÃ¡rias foram encontradas!")
        print("ğŸš€ Prosseguindo com a sincronizaÃ§Ã£o...")
        EOF
        
    - name: Setup Google Credentials
      run: |
        echo '${{ secrets.GOOGLE_CREDENTIALS }}' | base64 -d > credentials.json
        echo "GOOGLE_APPLICATION_CREDENTIALS=credentials.json" >> $GITHUB_ENV
        
    - name: Validate Google Drive Connection
      run: |
        python << EOF
        import os
        from google.oauth2 import service_account
        from googleapiclient.discovery import build
        
        print("ğŸ”— Testando conexÃ£o com Google Drive...")
        
        try:
            # Configurar credenciais
            credentials = service_account.Credentials.from_service_account_file(
                'credentials.json',
                scopes=['https://www.googleapis.com/auth/drive']
            )
            
            service = build('drive', 'v3', credentials=credentials)
            
            # Testar acesso Ã  pasta de destino
            folder_id = '${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}'
            folder_info = service.files().get(fileId=folder_id).execute()
            
            print(f"âœ… ConexÃ£o estabelecida com sucesso!")
            print(f"ğŸ“ Pasta de destino: {folder_info.get('name')}")
            print(f"ğŸ†” ID da pasta: {folder_id}")
            
            # Verificar permissÃµes
            permissions = service.permissions().list(fileId=folder_id).execute()
            print(f"ğŸ” PermissÃµes configuradas: {len(permissions.get('permissions', []))} entrada(s)")
            
        except Exception as e:
            print(f"âŒ Erro ao conectar com Google Drive: {str(e)}")
            print("\nğŸ’¡ PossÃ­veis causas:")
            print("- Credenciais invÃ¡lidas ou expiradas")
            print("- Pasta nÃ£o encontrada ou sem permissÃ£o")
            print("- Google Drive API nÃ£o habilitada")
            raise
        EOF
        
    - name: Sync Repository to Google Drive Folder
      run: |
        python << EOF
        import os
        import shutil
        from datetime import datetime
        from pathlib import Path
        from google.oauth2 import service_account
        from googleapiclient.discovery import build
        from googleapiclient.http import MediaFileUpload
        import io
        
        # ConfiguraÃ§Ãµes
        repo_name = '${{ github.event.repository.name }}'
        branch = '${{ github.ref_name }}'
        commit_sha = '${{ github.sha }}'
        parent_folder_id = '${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}'
        
        print(f"ğŸ”„ Sincronizando repositÃ³rio como pasta no Google Drive...")
        print(f"ğŸ“ RepositÃ³rio: {repo_name}")
        print(f"ğŸ”€ Branch: {branch}")
        print(f"ğŸ“ Commit: {commit_sha[:8]}")
        
        # Configurar Google Drive
        credentials = service_account.Credentials.from_service_account_file(
            'credentials.json',
            scopes=['https://www.googleapis.com/auth/drive']
        )
        
        service = build('drive', 'v3', credentials=credentials)
        
        # Verificar se a pasta do repositÃ³rio jÃ¡ existe
        query = f"name = '{repo_name}' and '{parent_folder_id}' in parents and mimeType = 'application/vnd.google-apps.folder' and trashed = false"
        
        results = service.files().list(
            q=query,
            fields='files(id,name)',
            spaces='drive'
        ).execute()
        
        existing_folders = results.get('files', [])
        
        if existing_folders:
            # Pasta existe - vamos limpar e atualizar
            repo_folder_id = existing_folders[0]['id']
            print(f"ğŸ“ Pasta encontrada: {repo_name} (ID: {repo_folder_id})")
            
            # Listar e deletar todos os arquivos dentro da pasta
            print("ğŸ§¹ Limpando pasta existente...")
            
            # Buscar todos os arquivos e subpastas
            query = f"'{repo_folder_id}' in parents and trashed = false"
            files_to_delete = []
            page_token = None
            
            while True:
                results = service.files().list(
                    q=query,
                    fields='nextPageToken, files(id,name)',
                    pageToken=page_token
                ).execute()
                
                files_to_delete.extend(results.get('files', []))
                page_token = results.get('nextPageToken')
                
                if not page_token:
                    break
            
            # Deletar arquivos encontrados
            for file in files_to_delete:
                try:
                    service.files().delete(fileId=file['id']).execute()
                except Exception as e:
                    print(f"  âš ï¸  Erro ao remover {file['name']}: {e}")
            
            print(f"  âœ… {len(files_to_delete)} arquivo(s) removido(s)")
            
        else:
            # Criar nova pasta
            print(f"ğŸ“ Criando nova pasta: {repo_name}")
            
            folder_metadata = {
                'name': repo_name,
                'mimeType': 'application/vnd.google-apps.folder',
                'parents': [parent_folder_id]
            }
            
            folder = service.files().create(
                body=folder_metadata,
                fields='id'
            ).execute()
            
            repo_folder_id = folder.get('id')
            print(f"âœ… Pasta criada com ID: {repo_folder_id}")
        
        # FunÃ§Ã£o para fazer upload recursivo de arquivos
        def upload_directory(local_path, parent_id, path_prefix=""):
            """Upload recursivo de diretÃ³rio para Google Drive"""
            
            uploaded_count = 0
            
            for item in os.listdir(local_path):
                item_path = os.path.join(local_path, item)
                
                # Pular diretÃ³rios e arquivos indesejados
                if item in ['.git', '__pycache__', 'node_modules', '.github', 'credentials.json']:
                    continue
                
                # Pular arquivos ocultos (exceto .gitignore)
                if item.startswith('.') and item != '.gitignore':
                    continue
                
                if os.path.isfile(item_path):
                    # Pular arquivos temporÃ¡rios e compilados
                    if item_path.endswith(('.pyc', '.pyo', '.pyd', '__pycache__', '.DS_Store')):
                        continue
                    
                    try:
                        file_metadata = {
                            'name': item,
                            'parents': [parent_id]
                        }
                        
                        # Determinar MIME type
                        mime_type = 'application/octet-stream'
                        if item.endswith('.txt'):
                            mime_type = 'text/plain'
                        elif item.endswith('.py'):
                            mime_type = 'text/x-python'
                        elif item.endswith('.md'):
                            mime_type = 'text/markdown'
                        elif item.endswith('.json'):
                            mime_type = 'application/json'
                        elif item.endswith(('.yml', '.yaml')):
                            mime_type = 'text/yaml'
                        elif item.endswith(('.jpg', '.jpeg')):
                            mime_type = 'image/jpeg'
                        elif item.endswith('.png'):
                            mime_type = 'image/png'
                        elif item.endswith('.pdf'):
                            mime_type = 'application/pdf'
                        
                        media = MediaFileUpload(
                            item_path,
                            mimetype=mime_type,
                            resumable=True
                        )
                        
                        file = service.files().create(
                            body=file_metadata,
                            media_body=media,
                            fields='id,name'
                        ).execute()
                        
                        uploaded_count += 1
                        
                    except Exception as e:
                        print(f"  âŒ Erro ao fazer upload de {item}: {str(e)[:50]}...")
                
                elif os.path.isdir(item_path):
                    # Criar subpasta e fazer upload recursivo
                    try:
                        # Criar subpasta no Drive
                        subfolder_metadata = {
                            'name': item,
                            'mimeType': 'application/vnd.google-apps.folder',
                            'parents': [parent_id]
                        }
                        
                        subfolder = service.files().create(
                            body=subfolder_metadata,
                            fields='id'
                        ).execute()
                        
                        subfolder_id = subfolder.get('id')
                        
                        # Upload recursivo do conteÃºdo
                        sub_count = upload_directory(item_path, subfolder_id, 
                                                   os.path.join(path_prefix, item) if path_prefix else item)
                        uploaded_count += sub_count
                        
                    except Exception as e:
                        print(f"  âŒ Erro ao criar pasta {item}: {str(e)[:50]}...")
            
            return uploaded_count
        
        # Fazer upload de todos os arquivos
        print("\nğŸ“¤ Fazendo upload dos arquivos...")
        total_uploaded = upload_directory('.', repo_folder_id)
        
        print(f"\nâœ… Total de arquivos enviados: {total_uploaded}")
        print(f"\nğŸ‰ SincronizaÃ§Ã£o concluÃ­da com sucesso!")
        print(f"ğŸ“ Pasta no Drive: {repo_name}")
        print(f"ğŸ”— LocalizaÃ§Ã£o: Sistema_GAD/Repositorios_Github_Gad/{repo_name}")
        EOF
        
    - name: Cleanup and Summary
      run: |
        python << EOF
        import os
        from datetime import datetime
        
        print("\nğŸ§¹ Limpando arquivos temporÃ¡rios...")
        
        # Remover apenas o arquivo de credenciais
        if os.path.exists('credentials.json'):
            os.remove('credentials.json')
            print("ğŸ—‘ï¸  Removido: credentials.json")
        
        # Resumo final
        commit_sha = '${{ github.sha }}'
        commit_short = commit_sha[:8] if len(commit_sha) > 8 else commit_sha
        
        print("\nğŸ“‹ RESUMO DA SINCRONIZAÃ‡ÃƒO")
        print("=" * 50)
        print(f"âœ… Status: ConcluÃ­da com sucesso")
        print(f"â° HorÃ¡rio: {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}")
        print(f"ğŸ¢ RepositÃ³rio: ${{ github.event.repository.name }}")
        print(f"ğŸŒ¿ Branch: ${{ github.ref_name }}")
        print(f"ğŸ“ Commit: {commit_short}")
        print(f"ğŸ‘¤ Autor: ${{ github.actor }}")
        print(f"ğŸ“ Sincronizado em: Sistema_GAD/Repositorios_Github_Gad/${{ github.event.repository.name }}")
        print("=" * 50)
        print("ğŸ‰ SincronizaÃ§Ã£o automÃ¡tica concluÃ­da!")
        EOF
