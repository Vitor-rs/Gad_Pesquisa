name: Sync Repository to Google Drive with Pre-checks

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  sync-to-drive:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Dependencies
      run: |
        pip install google-api-python-client google-auth google-auth-oauthlib google-auth-httplib2
        
    - name: Pre-check Environment Variables
      run: |
        python << EOF
        import os
        import sys
        
        print("ğŸ” Verificando variÃ¡veis de ambiente...")
        print("=" * 60)
        
        # VariÃ¡veis necessÃ¡rias
        required_vars = {
            'GOOGLE_CREDENTIALS': '${{ secrets.GOOGLE_CREDENTIALS }}',
            'GOOGLE_DRIVE_FOLDER_ID': '${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}'
        }
        
        # VariÃ¡veis opcionais do repositÃ³rio
        repo_vars = {
            'REPOSITORY_NAME': '${{ github.event.repository.name }}',
            'BRANCH': '${{ github.ref_name }}',
            'COMMIT_SHA': '${{ github.sha }}',
            'ACTOR': '${{ github.actor }}'
        }
        
        missing_vars = []
        
        # Verificar variÃ¡veis essenciais
        for name, value in required_vars.items():
            if value and value.strip():
                if 'CREDENTIALS' in name:
                    print(f"âœ… {name}: {'*' * 8}")
                else:
                    print(f"âœ… {name}: {value}")
            else:
                print(f"âŒ {name}: NÃƒO ENCONTRADA")
                missing_vars.append(name)
        
        # Mostrar variÃ¡veis do repositÃ³rio
        print("\nğŸ“‹ InformaÃ§Ãµes do repositÃ³rio:")
        for name, value in repo_vars.items():
            print(f"â„¹ï¸  {name}: {value}")
        
        # Verificar se temos o mÃ­nimo necessÃ¡rio
        if missing_vars:
            print(f"\nâŒ ERRO: VariÃ¡veis essenciais nÃ£o encontradas: {', '.join(missing_vars)}")
            print("\nVerifique se vocÃª configurou os secrets no GitHub:")
            print("- VÃ¡ em Settings â†’ Secrets and variables â†’ Actions")
            print("- Configure GOOGLE_CREDENTIALS e GOOGLE_DRIVE_FOLDER_ID")
            sys.exit(1)
        
        print("\nâœ… Todas as variÃ¡veis necessÃ¡rias foram encontradas!")
        print("ğŸš€ Prosseguindo com a sincronizaÃ§Ã£o...")
        EOF
        
    - name: Setup Google Credentials
      run: |
        echo '${{ secrets.GOOGLE_CREDENTIALS }}' | base64 -d > credentials.json
        echo "GOOGLE_APPLICATION_CREDENTIALS=credentials.json" >> $GITHUB_ENV
        
    - name: Validate Google Drive Connection
      run: |
        python << EOF
        import os
        from google.oauth2 import service_account
        from googleapiclient.discovery import build
        
        print("ğŸ”— Testando conexÃ£o com Google Drive...")
        
        try:
            # Configurar credenciais
            credentials = service_account.Credentials.from_service_account_file(
                'credentials.json',
                scopes=['https://www.googleapis.com/auth/drive']
            )
            
            service = build('drive', 'v3', credentials=credentials)
            
            # Testar acesso Ã  pasta de destino
            folder_id = '${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}'
            folder_info = service.files().get(fileId=folder_id).execute()
            
            print(f"âœ… ConexÃ£o estabelecida com sucesso!")
            print(f"ğŸ“ Pasta de destino: {folder_info.get('name')}")
            print(f"ğŸ†” ID da pasta: {folder_id}")
            
            # Verificar permissÃµes
            permissions = service.permissions().list(fileId=folder_id).execute()
            print(f"ğŸ” PermissÃµes configuradas: {len(permissions.get('permissions', []))} entrada(s)")
            
        except Exception as e:
            print(f"âŒ Erro ao conectar com Google Drive: {str(e)}")
            print("\nğŸ’¡ PossÃ­veis causas:")
            print("- Credenciais invÃ¡lidas ou expiradas")
            print("- Pasta nÃ£o encontrada ou sem permissÃ£o")
            print("- Google Drive API nÃ£o habilitada")
            raise
        EOF
        
    - name: Create Repository Archive
      run: |
        python << EOF
        import os
        import zipfile
        from datetime import datetime
        from pathlib import Path
        
        # InformaÃ§Ãµes do repositÃ³rio
        repo_name = '${{ github.event.repository.name }}'
        branch = '${{ github.ref_name }}'
        commit_sha = '${{ github.sha }}'
        timestamp = datetime.now().strftime('%Y%m%d-%H%M%S')
        
        zip_name = f'{repo_name}-{branch}-{timestamp}.zip'
        
        print(f"ğŸ“¦ Criando arquivo: {zip_name}")
        print(f"ğŸ”€ Branch: {branch}")
        print(f"ğŸ“ Commit: {commit_sha[:8]}")
        print(f"â° Timestamp: {timestamp}")
        
        # Contar arquivos antes de compactar
        file_count = 0
        excluded_count = 0
        
        with zipfile.ZipFile(zip_name, 'w', zipfile.ZIP_DEFLATED) as zipf:
            for root, dirs, files in os.walk('.'):
                # Excluir pastas desnecessÃ¡rias (similar ao seu cÃ³digo)
                dirs[:] = [d for d in dirs if d not in ['.git', '__pycache__', 'node_modules', '.github']]
                
                for file in files:
                    file_path = os.path.join(root, file)
                    
                    # Excluir arquivos desnecessÃ¡rios
                    if (not file.endswith(('.zip', '.pyc')) and 
                        file != 'credentials.json' and
                        not file.startswith('.')):
                        
                        zipf.write(file_path, file_path)
                        file_count += 1
                    else:
                        excluded_count += 1
        
        # Verificar tamanho do arquivo
        zip_size = os.path.getsize(zip_name)
        print(f"ğŸ“Š Arquivos incluÃ­dos: {file_count}")
        print(f"ğŸš« Arquivos excluÃ­dos: {excluded_count}")
        print(f"ğŸ“ Tamanho do arquivo: {zip_size:,} bytes ({zip_size/1024/1024:.2f} MB)")
        
        # Salvar informaÃ§Ãµes para prÃ³ximo step
        with open('sync_info.txt', 'w') as f:
            f.write(f"ZIP_NAME={zip_name}\n")
            f.write(f"FILE_COUNT={file_count}\n")
            f.write(f"ZIP_SIZE={zip_size}\n")
        
        print(f"âœ… Arquivo criado com sucesso: {zip_name}")
        EOF
        
    - name: Upload to Google Drive
      run: |
        python << EOF
        import os
        from datetime import datetime
        from google.oauth2 import service_account
        from googleapiclient.discovery import build
        from googleapiclient.http import MediaFileUpload
        
        # Ler informaÃ§Ãµes do step anterior
        sync_info = {}
        with open('sync_info.txt', 'r') as f:
            for line in f:
                key, value = line.strip().split('=', 1)
                sync_info[key] = value
        
        zip_name = sync_info['ZIP_NAME']
        file_count = sync_info['FILE_COUNT']
        zip_size = int(sync_info['ZIP_SIZE'])
        
        print(f"â¬†ï¸  Iniciando upload: {zip_name}")
        print(f"ğŸ“Š ContÃ©m {file_count} arquivos ({zip_size/1024/1024:.2f} MB)")
        
        # Configurar Google Drive
        credentials = service_account.Credentials.from_service_account_file(
            'credentials.json',
            scopes=['https://www.googleapis.com/auth/drive']
        )
        
        service = build('drive', 'v3', credentials=credentials)
        
        # Metadados do arquivo
        file_metadata = {
            'name': zip_name,
            'parents': ['${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}'],
            'description': f'Backup automÃ¡tico via GitHub Actions - Commit: ${{ github.sha }}'
        }
        
        # Upload com barra de progresso simulada
        print("ğŸ“¤ Fazendo upload...")
        media = MediaFileUpload(zip_name, resumable=True)
        
        request = service.files().create(
            body=file_metadata,
            media_body=media,
            fields='id,name,size,createdTime'
        )
        
        file = request.execute()
        
        # InformaÃ§Ãµes de sucesso
        print(f"\nğŸ‰ Upload concluÃ­do com sucesso!")
        print(f"ğŸ“ Nome: {file.get('name')}")
        print(f"ğŸ†” ID no Drive: {file.get('id')}")
        print(f"ğŸ“Š Tamanho: {file.get('size')} bytes")
        print(f"â° Criado em: {file.get('createdTime')}")
        print(f"ğŸ”— RepositÃ³rio: ${{ github.event.repository.name }}")
        print(f"ğŸŒ¿ Branch: ${{ github.ref_name }}")
        print(f"ğŸ‘¤ Autor: ${{ github.actor }}")
        EOF
        
    - name: Cleanup and Summary
      run: |
        python << EOF
        import os
        from datetime import datetime
        
        print("\nğŸ§¹ Limpando arquivos temporÃ¡rios...")
        
        # Remover arquivos temporÃ¡rios
        temp_files = ['credentials.json', 'sync_info.txt']
        for file in temp_files:
            if os.path.exists(file):
                os.remove(file)
                print(f"ğŸ—‘ï¸  Removido: {file}")
        
        # VariÃ¡veis do commit
        commit_sha = '${{ github.sha }}'
        commit_short = commit_sha[:8] if len(commit_sha) > 8 else commit_sha
        
        print("\nğŸ“‹ RESUMO DA SINCRONIZAÃ‡ÃƒO")
        print("=" * 50)
        print(f"âœ… Status: ConcluÃ­da com sucesso")
        print(f"â° HorÃ¡rio: {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}")
        print(f"ğŸ¢ RepositÃ³rio: ${{ github.event.repository.name }}")
        print(f"ğŸŒ¿ Branch: ${{ github.ref_name }}")
        print(f"ğŸ“ Commit: {commit_short}")
        print(f"ğŸ‘¤ Autor: ${{ github.actor }}")
        print(f"ğŸ¯ Destino: Google Drive/Sistema_GAD/Repositorios_Github_Gad")
        print("=" * 50)
        print("ğŸ‰ SincronizaÃ§Ã£o automÃ¡tica concluÃ­da!")
        EOF
        
    - name: Cleanup Old Backups (Optional)
      if: github.event_name == 'push'
      run: |
        python << EOF
        from google.oauth2 import service_account
        from googleapiclient.discovery import build
        from datetime import datetime, timedelta
        
        print("ğŸ§¹ Verificando backups antigos...")
        
        credentials = service_account.Credentials.from_service_account_file(
            'credentials.json',
            scopes=['https://www.googleapis.com/auth/drive']
        )
        
        service = build('drive', 'v3', credentials=credentials)
        
        try:
            # Buscar arquivos da pasta que sÃ£o do repositÃ³rio atual
            query = f"'${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}' in parents and name contains '${{ github.event.repository.name }}-'"
            
            results = service.files().list(
                q=query,
                orderBy='createdTime desc',
                fields='files(id,name,createdTime)'
            ).execute()
            
            files = results.get('files', [])
            print(f"ğŸ“Š Total de backups encontrados: {len(files)}")
            
            # Manter apenas os 15 backups mais recentes
            if len(files) > 15:
                files_to_delete = files[15:]
                print(f"ğŸ—‘ï¸  Removendo {len(files_to_delete)} backup(s) antigo(s)...")
                
                for old_file in files_to_delete:
                    service.files().delete(fileId=old_file['id']).execute()
                    print(f"  âœ… Removido: {old_file['name']}")
                
                print(f"âœ… Limpeza concluÃ­da. Mantidos os 15 backups mais recentes.")
            else:
                print("â„¹ï¸  Nenhum backup antigo para remover.")
                
        except Exception as e:
            print(f"âš ï¸  Aviso: NÃ£o foi possÃ­vel limpar backups antigos: {e}")
            print("ğŸ’¡ Isso nÃ£o afeta a sincronizaÃ§Ã£o principal.")
        EOF
