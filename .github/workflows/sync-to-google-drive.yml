name: Sync Repository to Google Drive (Institutional Account)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  sync-to-drive:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Dependencies
      run: |
        pip install google-api-python-client google-auth google-auth-oauthlib google-auth-httplib2
        
    - name: Create and Run Sync Script
      env:
        CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
        FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
      run: |
        cat > sync_drive.py << 'SCRIPT_END'
        import os
        import sys
        import json
        from datetime import datetime
        from google.oauth2.credentials import Credentials
        from google.auth.transport.requests import Request
        from googleapiclient.discovery import build
        from googleapiclient.http import MediaFileUpload, MediaInMemoryUpload
        from googleapiclient.errors import HttpError
        
        # ConfiguraÃ§Ãµes do ambiente
        CLIENT_ID = os.environ['CLIENT_ID']
        CLIENT_SECRET = os.environ['CLIENT_SECRET']
        REFRESH_TOKEN = os.environ['REFRESH_TOKEN']
        FOLDER_ID = os.environ['FOLDER_ID']
        
        # ConfiguraÃ§Ãµes do repositÃ³rio
        REPO_NAME = os.environ.get('GITHUB_REPOSITORY', '').split('/')[-1] or 'Gad_Pesquisa'
        BRANCH = os.environ.get('GITHUB_REF_NAME', 'main')
        COMMIT_SHA = os.environ.get('GITHUB_SHA', 'unknown')
        ACTOR = os.environ.get('GITHUB_ACTOR', 'unknown')
        
        # Pastas e arquivos a ignorar
        IGNORE_DIRS = {'.git', '__pycache__', 'node_modules', '.github', '.obsidian'}
        IGNORE_FILES = {'.DS_Store', 'Thumbs.db', 'desktop.ini'}
        IGNORE_EXTENSIONS = {'.pyc', '.pyo', '.tmp', '.log'}
        
        print("ðŸš€ Iniciando sincronizaÃ§Ã£o com Google Drive")
        print(f"ðŸ“ RepositÃ³rio: {REPO_NAME}")
        print(f"ðŸŒ¿ Branch: {BRANCH}")
        print(f"ðŸ“ Commit: {COMMIT_SHA[:8]}")
        print("="*60)
        
        # Criar credenciais OAuth2 usando refresh token
        creds = Credentials(
            token=None,
            refresh_token=REFRESH_TOKEN,
            token_uri='https://oauth2.googleapis.com/token',
            client_id=CLIENT_ID,
            client_secret=CLIENT_SECRET
        )
        
        # Renovar access token
        print("ðŸ”‘ Renovando access token...")
        creds.refresh(Request())
        print("âœ… Token renovado com sucesso!")
        
        # Criar serviÃ§o do Google Drive
        service = build('drive', 'v3', credentials=creds)
        
        # Obter informaÃ§Ãµes do usuÃ¡rio
        try:
            about = service.about().get(fields="user").execute()
            user_email = about['user']['emailAddress']
            print(f"ðŸ‘¤ Autenticado como: {user_email}")
        except:
            user_email = "unknown"
        
        def find_or_create_folder(parent_id, folder_name):
            """Encontra ou cria uma pasta no Google Drive"""
            # Buscar pasta existente
            query = f"name = '{folder_name}' and '{parent_id}' in parents and mimeType = 'application/vnd.google-apps.folder' and trashed = false"
            
            try:
                results = service.files().list(
                    q=query,
                    spaces='drive',
                    fields='files(id, name)'
                ).execute()
                
                files = results.get('files', [])
                
                if files:
                    folder_id = files[0]['id']
                    print(f"ðŸ“‚ Pasta encontrada: {folder_name} (ID: {folder_id})")
                    return folder_id
                else:
                    # Criar nova pasta
                    file_metadata = {
                        'name': folder_name,
                        'mimeType': 'application/vnd.google-apps.folder',
                        'parents': [parent_id]
                    }
                    
                    folder = service.files().create(
                        body=file_metadata,
                        fields='id'
                    ).execute()
                    
                    folder_id = folder.get('id')
                    print(f"ðŸ“‚ Pasta criada: {folder_name} (ID: {folder_id})")
                    return folder_id
                    
            except HttpError as error:
                print(f"âŒ Erro ao processar pasta {folder_name}: {error}")
                return None
        
        def clean_folder_contents(folder_id):
            """Remove conteÃºdo antigo da pasta antes de sincronizar"""
            try:
                # Listar todos os arquivos na pasta
                query = f"'{folder_id}' in parents and trashed = false"
                results = service.files().list(
                    q=query,
                    spaces='drive',
                    fields='files(id, name)'
                ).execute()
                
                files = results.get('files', [])
                
                if files:
                    print(f"ðŸ§¹ Limpando {len(files)} arquivos/pastas antigas...")
                    for file in files:
                        try:
                            service.files().delete(fileId=file['id']).execute()
                            print(f"  âœ“ Removido: {file['name']}")
                        except HttpError as e:
                            if e.resp.status == 403:
                                print(f"  âš ï¸ Sem permissÃ£o para remover: {file['name']}")
                            else:
                                print(f"  âŒ Erro ao remover {file['name']}: {e}")
                
            except HttpError as error:
                print(f"âš ï¸ Erro ao limpar pasta: {error}")
        
        def upload_file(file_path, parent_id):
            """Faz upload de um arquivo para o Google Drive"""
            file_name = os.path.basename(file_path)
            
            # Detectar tipo MIME
            mime_type = 'application/octet-stream'
            ext = os.path.splitext(file_name)[1].lower()
            
            mime_types = {
                '.txt': 'text/plain',
                '.md': 'text/markdown',
                '.py': 'text/x-python',
                '.js': 'text/javascript',
                '.json': 'application/json',
                '.yml': 'text/yaml',
                '.yaml': 'text/yaml',
                '.html': 'text/html',
                '.css': 'text/css',
                '.pdf': 'application/pdf',
                '.jpg': 'image/jpeg',
                '.jpeg': 'image/jpeg',
                '.png': 'image/png',
                '.gif': 'image/gif',
                '.svg': 'image/svg+xml',
                '.zip': 'application/zip'
            }
            
            if ext in mime_types:
                mime_type = mime_types[ext]
            
            # Verificar se arquivo jÃ¡ existe
            query = f"name = '{file_name}' and '{parent_id}' in parents and trashed = false"
            results = service.files().list(q=query, spaces='drive', fields='files(id)').execute()
            existing_files = results.get('files', [])
            
            try:
                if existing_files:
                    # Atualizar arquivo existente
                    file_id = existing_files[0]['id']
                    media = MediaFileUpload(file_path, mimetype=mime_type, resumable=True)
                    service.files().update(
                        fileId=file_id,
                        media_body=media
                    ).execute()
                    print(f"  ðŸ“ Atualizado: {file_name}")
                else:
                    # Criar novo arquivo
                    file_metadata = {
                        'name': file_name,
                        'parents': [parent_id]
                    }
                    media = MediaFileUpload(file_path, mimetype=mime_type, resumable=True)
                    service.files().create(
                        body=file_metadata,
                        media_body=media,
                        fields='id'
                    ).execute()
                    print(f"  âœ… Criado: {file_name}")
                    
            except HttpError as error:
                print(f"  âŒ Erro ao processar {file_name}: {error}")
                return False
            
            return True
        
        def sync_directory(local_path, parent_id, level=0):
            """Sincroniza recursivamente um diretÃ³rio com o Google Drive"""
            indent = "  " * level
            
            # Listar conteÃºdo do diretÃ³rio
            items = sorted(os.listdir(local_path))
            
            # Processar pastas primeiro
            for item in items:
                item_path = os.path.join(local_path, item)
                
                if os.path.isdir(item_path):
                    # Ignorar pastas especÃ­ficas
                    if item in IGNORE_DIRS:
                        continue
                    
                    print(f"{indent}ðŸ“ Processando pasta: {item}/")
                    
                    # Criar ou encontrar pasta no Drive
                    folder_id = find_or_create_folder(parent_id, item)
                    
                    if folder_id:
                        # Sincronizar recursivamente
                        sync_directory(item_path, folder_id, level + 1)
            
            # Processar arquivos
            for item in items:
                item_path = os.path.join(local_path, item)
                
                if os.path.isfile(item_path):
                    # Ignorar arquivos especÃ­ficos
                    if item in IGNORE_FILES:
                        continue
                    
                    # Ignorar por extensÃ£o
                    ext = os.path.splitext(item)[1].lower()
                    if ext in IGNORE_EXTENSIONS:
                        continue
                    
                    # Fazer upload do arquivo
                    upload_file(item_path, parent_id)
        
        # Processo principal de sincronizaÃ§Ã£o
        try:
            print("\nðŸ” Verificando estrutura de pastas no Google Drive...")
            
            # Encontrar ou criar pasta do repositÃ³rio
            repo_folder_id = find_or_create_folder(FOLDER_ID, REPO_NAME)
            
            if not repo_folder_id:
                print("âŒ Erro ao criar/encontrar pasta do repositÃ³rio")
                sys.exit(1)
            
            # Limpar conteÃºdo antigo
            print("\nðŸ§¹ Limpando conteÃºdo antigo...")
            clean_folder_contents(repo_folder_id)
            
            # Criar arquivo de informaÃ§Ãµes da sincronizaÃ§Ã£o
            sync_info = """SincronizaÃ§Ã£o AutomÃ¡tica - GitHub Actions
        =====================================
        RepositÃ³rio: %s
        Branch: %s
        Commit: %s
        Autor: %s
        Data: %s
        Conta: %s
        =====================================
        
        Esta pasta Ã© sincronizada automaticamente com o repositÃ³rio GitHub.
        AlteraÃ§Ãµes feitas diretamente aqui podem ser sobrescritas na prÃ³xima sincronizaÃ§Ã£o.
        """ % (REPO_NAME, BRANCH, COMMIT_SHA, ACTOR, datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC'), user_email)
            
            # Upload do arquivo de info
            media = MediaInMemoryUpload(sync_info.encode('utf-8'), mimetype='text/plain')
            file_metadata = {
                'name': '_SYNC_INFO.txt',
                'parents': [repo_folder_id]
            }
            service.files().create(
                body=file_metadata,
                media_body=media,
                fields='id'
            ).execute()
            
            # Sincronizar arquivos do repositÃ³rio
            print("\nðŸ“¤ Sincronizando arquivos...")
            total_uploaded = 0
            
            # Contar arquivos
            for root, dirs, files in os.walk('.'):
                dirs[:] = [d for d in dirs if d not in IGNORE_DIRS]
                for file in files:
                    if file not in IGNORE_FILES:
                        ext = os.path.splitext(file)[1].lower()
                        if ext not in IGNORE_EXTENSIONS:
                            total_uploaded += 1
            
            print(f"ðŸ“Š Total de arquivos a sincronizar: {total_uploaded}")
            
            # Executar sincronizaÃ§Ã£o
            sync_directory('.', repo_folder_id)
            
            # Resumo final
            print("\n" + "="*60)
            print("âœ… SINCRONIZAÃ‡ÃƒO CONCLUÃDA COM SUCESSO!")
            print("="*60)
            print(f"ðŸ“ RepositÃ³rio: {REPO_NAME}")
            print(f"ðŸ”€ Branch: {BRANCH}")
            print(f"ðŸ“ Commit: {COMMIT_SHA[:8]}")
            print(f"ðŸ“Š Arquivos processados: {total_uploaded}")
            print(f"ðŸ‘¤ Conta: {user_email}")
            print(f"â° HorÃ¡rio: {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}")
            print(f"ðŸŽ¯ LocalizaÃ§Ã£o: Sistema_GAD/Repositorios_Github_Gad/{REPO_NAME}")
            print("="*60)
            print("âœ¨ SincronizaÃ§Ã£o automÃ¡tica usando conta institucional!")
            
        except HttpError as error:
            print(f"\nâŒ Erro durante sincronizaÃ§Ã£o: {error}")
            sys.exit(1)
        except Exception as e:
            print(f"\nâŒ Erro inesperado: {str(e)}")
            sys.exit(1)
        
        SCRIPT_END
        
        # Executar o script
        python sync_drive.py
