name: Sync Repository to Google Drive with Pre-checks

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  sync-to-drive:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Dependencies
      run: |
        pip install google-api-python-client google-auth google-auth-oauthlib google-auth-httplib2
        
    - name: Pre-check Environment Variables
      run: |
        python << EOF
        import os
        import sys
        
        print("üîç Verificando vari√°veis de ambiente...")
        print("=" * 60)
        
        # Vari√°veis necess√°rias
        required_vars = {
            'GOOGLE_CREDENTIALS': '${{ secrets.GOOGLE_CREDENTIALS }}',
            'GOOGLE_DRIVE_FOLDER_ID': '${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}'
        }
        
        # Vari√°veis opcionais do reposit√≥rio
        repo_vars = {
            'REPOSITORY_NAME': '${{ github.event.repository.name }}',
            'BRANCH': '${{ github.ref_name }}',
            'COMMIT_SHA': '${{ github.sha }}',
            'ACTOR': '${{ github.actor }}'
        }
        
        missing_vars = []
        
        # Verificar vari√°veis essenciais
        for name, value in required_vars.items():
            if value and value.strip():
                if 'CREDENTIALS' in name:
                    print(f"‚úÖ {name}: {'*' * 8}")
                else:
                    print(f"‚úÖ {name}: {value}")
            else:
                print(f"‚ùå {name}: N√ÉO ENCONTRADA")
                missing_vars.append(name)
        
        # Mostrar vari√°veis do reposit√≥rio
        print("\nüìã Informa√ß√µes do reposit√≥rio:")
        for name, value in repo_vars.items():
            print(f"‚ÑπÔ∏è  {name}: {value}")
        
        # Verificar se temos o m√≠nimo necess√°rio
        if missing_vars:
            print(f"\n‚ùå ERRO: Vari√°veis essenciais n√£o encontradas: {', '.join(missing_vars)}")
            print("\nVerifique se voc√™ configurou os secrets no GitHub:")
            print("- V√° em Settings ‚Üí Secrets and variables ‚Üí Actions")
            print("- Configure GOOGLE_CREDENTIALS e GOOGLE_DRIVE_FOLDER_ID")
            sys.exit(1)
        
        print("\n‚úÖ Todas as vari√°veis necess√°rias foram encontradas!")
        print("üöÄ Prosseguindo com a sincroniza√ß√£o...")
        EOF
        
    - name: Setup Google Credentials
      run: |
        echo '${{ secrets.GOOGLE_CREDENTIALS }}' | base64 -d > credentials.json
        echo "GOOGLE_APPLICATION_CREDENTIALS=credentials.json" >> $GITHUB_ENV
        
    - name: Validate Google Drive Connection
      run: |
        python << EOF
        import os
        from google.oauth2 import service_account
        from googleapiclient.discovery import build
        
        print("üîó Testando conex√£o com Google Drive...")
        
        try:
            # Configurar credenciais
            credentials = service_account.Credentials.from_service_account_file(
                'credentials.json',
                scopes=['https://www.googleapis.com/auth/drive']
            )
            
            service = build('drive', 'v3', credentials=credentials)
            
            # Testar acesso √† pasta de destino
            folder_id = '${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}'
            folder_info = service.files().get(fileId=folder_id).execute()
            
            print(f"‚úÖ Conex√£o estabelecida com sucesso!")
            print(f"üìÅ Pasta de destino: {folder_info.get('name')}")
            print(f"üÜî ID da pasta: {folder_id}")
            
            # Verificar permiss√µes
            permissions = service.permissions().list(fileId=folder_id).execute()
            print(f"üîê Permiss√µes configuradas: {len(permissions.get('permissions', []))} entrada(s)")
            
        except Exception as e:
            print(f"‚ùå Erro ao conectar com Google Drive: {str(e)}")
            print("\nüí° Poss√≠veis causas:")
            print("- Credenciais inv√°lidas ou expiradas")
            print("- Pasta n√£o encontrada ou sem permiss√£o")
            print("- Google Drive API n√£o habilitada")
            raise
        EOF
        
    - name: Create Repository Archive
      run: |
        python << EOF
        import os
        import zipfile
        from datetime import datetime
        from pathlib import Path
        
        # Informa√ß√µes do reposit√≥rio
        repo_name = '${{ github.event.repository.name }}'
        branch = '${{ github.ref_name }}'
        commit_sha = '${{ github.sha }}'
        timestamp = datetime.now().strftime('%Y%m%d-%H%M%S')
        
        zip_name = f'{repo_name}-{branch}-{timestamp}.zip'
        
        print(f"üì¶ Criando arquivo: {zip_name}")
        print(f"üîÄ Branch: {branch}")
        print(f"üìù Commit: {commit_sha[:8]}")
        print(f"‚è∞ Timestamp: {timestamp}")
        
        # Contar arquivos antes de compactar
        file_count = 0
        excluded_count = 0
        
        with zipfile.ZipFile(zip_name, 'w', zipfile.ZIP_DEFLATED) as zipf:
            for root, dirs, files in os.walk('.'):
                # Excluir pastas desnecess√°rias (similar ao seu c√≥digo)
                dirs[:] = [d for d in dirs if d not in ['.git', '__pycache__', 'node_modules', '.github']]
                
                for file in files:
                    file_path = os.path.join(root, file)
                    
                    # Excluir arquivos desnecess√°rios
                    if (not file.endswith(('.zip', '.pyc')) and 
                        file != 'credentials.json' and
                        not file.startswith('.')):
                        
                        zipf.write(file_path, file_path)
                        file_count += 1
                    else:
                        excluded_count += 1
        
        # Verificar tamanho do arquivo
        zip_size = os.path.getsize(zip_name)
        print(f"üìä Arquivos inclu√≠dos: {file_count}")
        print(f"üö´ Arquivos exclu√≠dos: {excluded_count}")
        print(f"üìè Tamanho do arquivo: {zip_size:,} bytes ({zip_size/1024/1024:.2f} MB)")
        
        # Salvar informa√ß√µes para pr√≥ximo step
        with open('sync_info.txt', 'w') as f:
            f.write(f"ZIP_NAME={zip_name}\n")
            f.write(f"FILE_COUNT={file_count}\n")
            f.write(f"ZIP_SIZE={zip_size}\n")
        
        print(f"‚úÖ Arquivo criado com sucesso: {zip_name}")
        EOF
        
    - name: Upload to Google Drive
      run: |
        python << EOF
        import os
        from datetime import datetime
        from google.oauth2 import service_account
        from googleapiclient.discovery import build
        from googleapiclient.http import MediaFileUpload
        
        # Ler informa√ß√µes do step anterior
        sync_info = {}
        with open('sync_info.txt', 'r') as f:
            for line in f:
                key, value = line.strip().split('=', 1)
                sync_info[key] = value
        
        zip_name = sync_info['ZIP_NAME']
        file_count = sync_info['FILE_COUNT']
        zip_size = int(sync_info['ZIP_SIZE'])
        
        print(f"‚¨ÜÔ∏è  Iniciando upload: {zip_name}")
        print(f"üìä Cont√©m {file_count} arquivos ({zip_size/1024/1024:.2f} MB)")
        
        # Configurar Google Drive
        credentials = service_account.Credentials.from_service_account_file(
            'credentials.json',
            scopes=['https://www.googleapis.com/auth/drive']
        )
        
        service = build('drive', 'v3', credentials=credentials)
        
        # Metadados do arquivo
        file_metadata = {
            'name': zip_name,
            'parents': ['${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}'],
            'description': f'Backup autom√°tico via GitHub Actions - Commit: ${{ github.sha }}'
        }
        
        # Upload com barra de progresso simulada
        print("üì§ Fazendo upload...")
        media = MediaFileUpload(zip_name, resumable=True)
        
        request = service.files().create(
            body=file_metadata,
            media_body=media,
            fields='id,name,size,createdTime'
        )
        
        file = request.execute()
        
        # Informa√ß√µes de sucesso
        print(f"\nüéâ Upload conclu√≠do com sucesso!")
        print(f"üìÅ Nome: {file.get('name')}")
        print(f"üÜî ID no Drive: {file.get('id')}")
        print(f"üìä Tamanho: {file.get('size')} bytes")
        print(f"‚è∞ Criado em: {file.get('createdTime')}")
        print(f"üîó Reposit√≥rio: ${{ github.event.repository.name }}")
        print(f"üåø Branch: ${{ github.ref_name }}")
        print(f"üë§ Autor: ${{ github.actor }}")
        EOF
        
    - name: Cleanup and Summary
      run: |
        python << EOF
        import os
        from datetime import datetime
        
        print("\nüßπ Limpando arquivos tempor√°rios...")
        
        # Remover arquivos tempor√°rios
        temp_files = ['credentials.json', 'sync_info.txt']
        for file in temp_files:
            if os.path.exists(file):
                os.remove(file)
                print(f"üóëÔ∏è  Removido: {file}")
        
        # Remover arquivo ZIP
        sync_info = {}
        if os.path.exists('sync_info.txt'):
            with open('sync_info.txt', 'r') as f:
                for line in f:
                    key, value = line.strip().split('=', 1)
                    sync_info[key] = value
        
        print("\nüìã RESUMO DA SINCRONIZA√á√ÉO")
        print("=" * 50)
        print(f"‚úÖ Status: Conclu√≠da com sucesso")
        print(f"‚è∞ Hor√°rio: {datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')}")
        print(f"üè¢ Reposit√≥rio: ${{ github.event.repository.name }}")
        print(f"üåø Branch: ${{ github.ref_name }}")
        print(f"üìù Commit: ${{ github.sha }}".[:50] + "...")
        print(f"üë§ Autor: ${{ github.actor }}")
        print(f"üéØ Destino: Google Drive/Sistema_GAD/Repositorios_Github_Gad")
        print("=" * 50)
        print("üéâ Sincroniza√ß√£o autom√°tica conclu√≠da!")
        EOF
        
    - name: Cleanup Old Backups (Optional)
      if: github.event_name == 'push'
      run: |
        python << EOF
        from google.oauth2 import service_account
        from googleapiclient.discovery import build
        from datetime import datetime, timedelta
        
        print("üßπ Verificando backups antigos...")
        
        credentials = service_account.Credentials.from_service_account_file(
            'credentials.json',
            scopes=['https://www.googleapis.com/auth/drive']
        )
        
        service = build('drive', 'v3', credentials=credentials)
        
        try:
            # Buscar arquivos da pasta que s√£o do reposit√≥rio atual
            query = f"'{{\{{ secrets.GOOGLE_DRIVE_FOLDER_ID }}}}' in parents and name contains '${{ github.event.repository.name }}-'"
            
            results = service.files().list(
                q=query,
                orderBy='createdTime desc',
                fields='files(id,name,createdTime)'
            ).execute()
            
            files = results.get('files', [])
            print(f"üìä Total de backups encontrados: {len(files)}")
            
            # Manter apenas os 15 backups mais recentes
            if len(files) > 15:
                files_to_delete = files[15:]
                print(f"üóëÔ∏è  Removendo {len(files_to_delete)} backup(s) antigo(s)...")
                
                for old_file in files_to_delete:
                    service.files().delete(fileId=old_file['id']).execute()
                    print(f"  ‚úÖ Removido: {old_file['name']}")
                
                print(f"‚úÖ Limpeza conclu√≠da. Mantidos os 15 backups mais recentes.")
            else:
                print("‚ÑπÔ∏è  Nenhum backup antigo para remover.")
                
        except Exception as e:
            print(f"‚ö†Ô∏è  Aviso: N√£o foi poss√≠vel limpar backups antigos: {e}")
            print("üí° Isso n√£o afeta a sincroniza√ß√£o principal.")
        EOF
